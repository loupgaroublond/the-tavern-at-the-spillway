# Session Handoff: The Tavern at the Spillway

**Date:** 2026-01-21
**Session:** cozy-sprouting-grove
**Project:** /Users/yankee/Documents/Projects/the-tavern-at-the-spillway


## What This Project Is

A multi-agent orchestrator for macOS. Jake is the top-level coordinating agent ("The Proprietor"). He has a distinctive used-car-salesman voice but delivers flawless work. See `CLAUDE.md` for the full character spec.

**Tech Stack:**
- Swift 6, SwiftUI, macOS 13+
- ClaudeCodeSDK (third-party Swift wrapper for Claude CLI)
- XcodeGen for project generation
- Swift Package Manager for dependencies


## Project Structure

```
the-tavern-at-the-spillway/
├── Tavern/                          # Main Swift package
│   ├── Package.swift                # SPM manifest
│   ├── project.yml                  # XcodeGen config
│   ├── Tavern.entitlements          # App sandbox disabled
│   ├── Sources/
│   │   ├── Tavern/                  # App target (SwiftUI)
│   │   │   ├── TavernApp.swift      # Entry point, dependency wiring
│   │   │   └── Views/               # SwiftUI views
│   │   └── TavernCore/              # Framework target
│   │       ├── Agents/              # Jake.swift, MortalAgent.swift
│   │       ├── Chat/                # ChatViewModel.swift, ChatMessage.swift
│   │       ├── Coordination/        # TavernCoordinator.swift, AgentSpawner.swift
│   │       ├── Commitments/         # Commitment verification system
│   │       ├── Errors/              # TavernErrorMessages.swift
│   │       ├── Naming/              # NameGenerator.swift, NamingTheme.swift
│   │       ├── Persistence/         # DocStore.swift, AgentPersistence.swift
│   │       └── Registry/            # AgentRegistry.swift
│   └── Tests/
│       ├── TavernTests/             # Integration tests
│       └── TavernCoreTests/         # Unit tests (172 tests, all passing)
├── docs/
│   ├── architecture-v1.md           # Comprehensive architecture guide
│   ├── seed-design/                 # Design transcripts
│   └── prd.md, implementation-plan.md
└── scripts/
    └── loc.sh                       # Line count by category
```


## Workflows

### Seed Design Interview Process (CRITICAL)

This project uses a **formalized interview methodology** for design discussions:

**The Process:**
1. **Continuous Interview** — Claude asks questions to understand user's vision with high fidelity. Keep asking rather than making assumptions.

2. **Two Input Streams**:
   - User describes concepts in general strokes
   - Line-by-line walkthrough of reference materials

3. **Transcript Notation**:
   - **[U]** = User's words (high fidelity, like a magazine interview)
   - **[C]** = Claude's responses
   - **[T]** = Claude's thinking/reasoning (italics, when it adds understanding)
   - **[S]** = Synthesis (after `___` divider, when new whole ideas emerge)

4. **Transcribe-and-Commit** — User periodically invokes `/commit` which:
   - Updates transcript in `docs/seed-design/transcript_*.md`
   - If compacted, uses rewind agent to get actual words (not summaries)
   - Makes descriptive commit

**Why This Exists:**
- **Context Continuity** — Refer back after compaction
- **Multi-Session Design** — Spans real-world days
- **High Fidelity** — Built to user's concept, not generic best practices
- **Prevent Assumption Drift** — Actual dialogue preserved, not just summaries
- **Documentation Artifact** — Shows not just what was decided, but WHY

**Files:** `docs/seed-design/transcript_*.md` — Interview dialogue with notation

**Key Rule:** When new principles are discovered during implementation, they get transcribed and committed to preserve design rationale.


### Build and Run App

```bash
cd Tavern

# One-liner: build and run
# Uses ~/.local/builds to avoid iCloud sync interference with code signing
xcodebuild -project Tavern.xcodeproj -scheme Tavern build -derivedDataPath ~/.local/builds/tavern && open ~/.local/builds/tavern/Build/Products/Debug/Tavern.app

# Kill existing and restart (for iteration)
pkill -f "Tavern.app" 2>/dev/null; open ~/.local/builds/tavern/Build/Products/Debug/Tavern.app
```

### After Changing project.yml

```bash
cd Tavern
xcodegen generate   # Regenerates Tavern.xcodeproj
# Then build as normal
```

### Run Tests

```bash
cd Tavern
swift test                           # All tests
swift test --filter TavernCoreTests  # Just unit tests
swift test --filter TavernTests      # Just integration tests
```

### Check Line Counts

```bash
./scripts/loc.sh
```

### Commit Workflow

User uses `/commit` command which:
1. Updates transcript in `docs/seed-design/`
2. Makes a descriptive commit with `Co-Authored-By: Claude Opus 4.5`

### Transcript Workflow

When committing, update or create transcript file in `docs/seed-design/transcript_YYYY-MM-DD-HHMM.md` documenting:
- Key user requests
- Design decisions made
- Files created/modified
- Principles established


## Current State

**What Works:**
- App builds and launches
- Jake responds to messages (using `.text` format workaround)
- Agent spawning with themed names
- Agent registry and list view
- Commitment system (create, verify, track)
- Doc store persistence
- 172 tests passing

**Known Bug (SDK Issue):**
ClaudeCodeSDK has a JSON parsing bug:
- Claude CLI `--output-format json` returns a JSON **array** of events
- SDK expects a single JSON **object**
- **Workaround:** Using `.text` format instead of `.json` in Jake.swift and MortalAgent.swift
- **Proper fix:** Fork ClaudeCodeSDK and fix `HeadlessBackend.swift` to parse arrays
- This means we currently lose session ID tracking

**Not Implemented Yet:**
- Project root selection (Jake works from app's cwd, usually `/`)
- Real verification logic (commitments use mock runner)
- Background agent execution
- Agent-to-agent communication


## Design Principles Established

1. **Informative Error Principle** — Error messages must be informative and actionable, not "something went wrong". Every error case maps to a user-friendly message in `TavernErrorMessages.swift`.

2. **Sum Type Error Design** — Use GADTs/sum types to enumerate all failure modes upfront. Forces comprehensive handling at design time.

3. **Autonomous Testing Principle** — Tests should not require human interaction to run or verify.

4. **Instrumentation Principle** — Debug builds must be instrumented thoroughly enough that logs alone can diagnose issues. Currently enabled via `config.enableDebugLogging = true` in TavernApp.swift.

5. **App Restart Workflow** — When rebuilding the app, offer to restart it for the user (or do it autonomously for clear cases like bug fixes).


## Key Files to Know

| File | Purpose |
|------|---------|
| `CLAUDE.md` | Jake's character spec, vocabulary, voice principles |
| `docs/architecture-v1.md` | Full architecture documentation |
| `Sources/TavernCore/Agents/Jake.swift` | Main agent implementation |
| `Sources/TavernCore/Errors/TavernErrorMessages.swift` | Error-to-message mapping |
| `Sources/Tavern/TavernApp.swift` | App entry point, dependency injection |
| `Tests/TavernTests/SDKDiagnosticTests.swift` | Tests documenting SDK bug |


## Debugging Workflow

### Viewing Logs

The app uses `os.log` with subsystem `com.tavern.spillway`. To view logs:

**Console.app:**
1. Open Console.app (Applications > Utilities)
2. Start the Tavern app
3. In Console.app, filter by: `subsystem:com.tavern.spillway`
4. Optional category filters: `category:agents`, `category:chat`, `category:coordination`, `category:claude`

**Terminal (live streaming):**
```bash
log stream --predicate 'subsystem == "com.tavern.spillway"' --level debug
```

### Diagnosing Issues

1. Reproduce the issue with the app running
2. Check Console.app logs filtered to `com.tavern.spillway`
3. Look for:
   - `.error` level entries (failures)
   - State transitions leading up to the error
   - API call parameters and responses

Logs should contain enough context to diagnose issues without needing screenshots or videos.


### Honor System Note for Claude

When working on this project, Claude must adhere to the same development standards as human developers:

1. **Logging** — All new code must include appropriate logging via `TavernLogger`
2. **Testing** — Every new feature requires tests (unit and/or integration)
3. **Stress Testing** — Changes affecting scale or concurrency require stress test coverage
4. **No silent failures** — Every error must be logged with context

These standards are documented in `docs/seed-design/prd_2026-01-19.md` Section 19.


## Recent Commits

```
53a02bc Fix error test and add transcript for error handling session
47ec54f Note SDK fork as fix path (not TODO)
4cabca6 Document Instrumentation Principle for autonomous debugging
7e3df5c Fix error handling and ClaudeCodeSDK JSON parsing bug workaround
401584e Add v1 architecture documentation
3b4bf21 Add line-of-code counting script
30820c9 Add XcodeGen configuration for building Tavern.app
```


## User Preferences (from ~/.claude/CLAUDE.md)

- **Verbatim copying first**: Fetch and copy verbatim, then modify
- **Complete information display**: Don't truncate outputs unless asked
- **jq for JSON/JSONL**: Always use jq for parsing structured data
- **Test iteratively**: Make changes incrementally and test after each
- **Always ask clarifying questions**: Extra round-trip beats wrong assumptions
- **Positive framing**: "Shell redirects will cause X" not "Don't use redirects"
- **Markdown formatting**: 2 newlines between paragraphs and list items
- **Use bd (beads) for issue tracking**: Not markdown TODOs


## What User Was Doing

User asked to rebuild and run the app after test fix commit. Then requested this handoff dump because session is long and app getting slow.


## Session History for Rewind

See **`cozy-sprouting-grove-sessions.md`** for full list of session IDs.

**Key sessions:**
- `2644cc60-d7a4-4659-b36a-81bb776d5e5a` — Current (XcodeGen, error handling, SDK bug)
- `6fe5cbf1-73f3-4e7a-bc1f-80925fddb85e` — Primary design (/conceive, Jake character, architecture)
- `b6669651-f4e9-4236-9a63-8fdebe4cb284` — Implementation (agents, commitments, doc store)


## Next Steps (User's Call)

1. Rebuild and run the app to test
2. Consider forking ClaudeCodeSDK to fix the JSON array parsing bug
3. Implement project root selection so Jake can work on specific directories
