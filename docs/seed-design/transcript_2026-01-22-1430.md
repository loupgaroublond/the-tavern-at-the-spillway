# Transcript: SDK Fix, Blocks, Sessions, Agent Spawning

**Date:** 2026-01-22 14:30
**Session:** Implementation plan for agent creation, SDK fix, block display, and session persistence


## Context

Current state: Tavern works as document-based app. Jake responds but uses `.text` format due to SDK bug. No session persistence, no content blocks displayed, no agent spawning UI.


## Key Design Decisions (Recovered from Pre-Compaction)


### 1. SDK Bug: Fork vs Streaming

**The Problem:**
ClaudeCodeSDK's `.json` format is broken. The SDK expects Claude CLI to return a single JSON object, but it actually returns an array of JSON objects (newline-delimited). This breaks session ID tracking.

**Discussion:**
- Streaming (`.streamJson`) works correctly in the SDK — it handles newline-delimited JSON
- However, streaming adds complexity: Combine publishers, partial states, UI updates mid-response
- Forking to fix `.json` is simpler: ~10 lines of code change

**Decision:**
Fork the SDK and fix the JSON parsing. Streaming is a future enhancement, not required for MVP.

**Fix approach:**
```swift
// Current (broken):
let resultMessage = try decoder.decode(ResultMessage.self, from: data)

// Fixed:
// Parse as newline-delimited JSON, find the result object
let lines = output.components(separatedBy: "\n").filter { !$0.isEmpty }
for line in lines {
    if let data = line.data(using: .utf8),
       let json = try? JSONSerialization.jsonObject(with: data) as? [String: Any],
       json["type"] as? String == "result" {
        let resultMessage = try decoder.decode(ResultMessage.self, from: data)
        return .json(resultMessage)
    }
}
```


### 2. Session ID Locality

**Discovery:**
Session IDs are stored in `~/.claude/projects/` which is machine-local. These paths are specific to the local machine and shouldn't be shared via DocStore or version control.

**Decision:**
Session persistence uses UserDefaults (machine-local), NOT DocStore. DocStore is for shareable/version-controllable content like agent definitions and configs.

**Storage layers clarified:**
1. **Claude SDK** — session history (in `~/.claude/projects/`)
2. **`.tavern/`** — shareable config, templates (version-controllable)
3. **UserDefaults/iCloud** — personal state, session IDs (not shared)


### 3. Typewriter Effect

**Idea:**
Even when using non-streaming transport, display responses with a typewriter effect — characters appearing progressively. This is a display flourish independent of how data arrives.

**Rationale:**
- Separates "feel" from transport
- Could apply to cached or instant responses too
- Creates consistent UX regardless of underlying implementation

**Decision:**
Typewriter effect is a future polish item. Focus first on functional blocks, then add display effects.


### 4. Content Blocks

**What Claude returns:**
Claude's JSON response includes a `content` array with typed blocks:
- `text` — plain text content
- `tool_use` — tool invocation (name, input)
- `tool_result` — result from tool (content, isError)
- `thinking` — Claude's thinking process
- `web_search_result` — web search output

**Decision:**
Enhance ChatMessage to carry message type, then render different views per type. Each block becomes its own message in the chat history for clarity.


### 5. Agent Creation UI

**Current state:**
`TavernCoordinator.spawnAgent(assignment:)` exists but has no UI.

**Decision:**
Add a simple spawn sheet with assignment text field and optional custom name. Wire to existing coordinator method.


## Implementation Plan

### Phase 1: Fork SDK
1. Fork ClaudeCodeSDK to own repo
2. Fix HeadlessBackend.swift JSON parsing
3. Update Package.swift to use forked SDK
4. Update Jake.swift and MortalAgent.swift to use `.json` format

### Phase 2: Content Blocks
1. Add MessageType enum to ChatMessage
2. Parse ResultMessage.content blocks into separate messages
3. Create block-specific SwiftUI views
4. Update ChatView to render by type

### Phase 3: Agent Spawn UI
1. Add toolbar button to AgentListView
2. Create SpawnAgentSheet with form
3. Wire to TavernCoordinator.spawnAgent()

### Phase 4: Session Persistence
1. Create SessionStore (UserDefaults wrapper)
2. Save/load Jake's session ID on launch/response
3. Save/load agent sessions keyed by agent ID


## Implementation Complete


### Phase 1: SDK Fork

- **Created:** `Tavern/LocalPackages/ClaudeCodeSDK/` — Local fork of the SDK
- **Fixed:** `HeadlessBackend.swift` lines 432-453 — Now parses newline-delimited JSON correctly
- **Updated:** `Tavern/Package.swift` — Points to local package instead of remote
- **Updated:** `Jake.swift` and `MortalAgent.swift` — Now use `.json` format

The fix iterates over output lines, finds the one with `"type": "result"`, and decodes that as `ResultMessage`.


### Phase 2: Content Blocks Infrastructure

- **Added:** `MessageType` enum to `ChatMessage.swift` — text, toolUse, toolResult, toolError, thinking, webSearch
- **Added:** `toolName: String?` and `isError: Bool` fields to `ChatMessage`
- **Updated:** `ChatView.swift` — Renders messages based on type with distinct visual styles

**Note:** Full content blocks (tool use/result) only available with streaming. Current `.json` format gives session ID and final result text. Block rendering infrastructure is ready for when streaming is added.


### Phase 3: Agent Spawn UI

- **Added:** `SpawnAgentSheet` view in `AgentListView.swift`
- **Added:** Toolbar `+` button to open spawn sheet
- **Added:** `onSpawnAgent` callback pattern to wire UI to coordinator
- **Updated:** `TavernApp.swift` `ProjectContentView` — Passes spawn callback to `AgentListView`


### Phase 4: Session Persistence

- **Created:** `TavernCore/Persistence/SessionStore.swift` — UserDefaults wrapper for session IDs
- **Updated:** `Jake.swift` — Loads saved session on init, saves after each response
- **Updated:** `MortalAgent.swift` — Same persistence pattern
- **Added:** `loadSavedSession: Bool` parameter to both agents (defaults true, tests use false)


### Files Created/Modified

| File | Change |
|------|--------|
| `LocalPackages/ClaudeCodeSDK/...HeadlessBackend.swift` | Fixed JSON array parsing |
| `Tavern/Package.swift` | Local SDK dependency |
| `TavernCore/Agents/Jake.swift` | `.json` format, session persistence |
| `TavernCore/Agents/MortalAgent.swift` | `.json` format, session persistence |
| `TavernCore/Chat/ChatMessage.swift` | MessageType enum, new fields |
| `Tavern/Views/ChatView.swift` | Block-aware message rendering |
| `Tavern/Views/AgentListView.swift` | SpawnAgentSheet, toolbar button |
| `Tavern/TavernApp.swift` | Spawn callback wiring |
| `TavernCore/Persistence/SessionStore.swift` | NEW — UserDefaults session storage |
| `Tests/.../*.swift` | Added `loadSavedSession: false` to Jake inits |


### Test Results

All 173 tests pass.


---


## Future Work (Not This Pass)

- **Streaming:** Switch to `.streamJson` for real-time UI updates and full content blocks
- **Typewriter effect:** Render characters progressively as display flourish
- **SwiftData:** Consider for richer persistence once use cases mapped


---

*Recovered from session dd9d562e-0aac-4751-a732-2e43da617afe. Implementation completed same session.*
