# Transcript: Instrumentation & Stress Testing Implementation

**Date:** 2026-01-21 16:20
**Session:** Implementation of logging infrastructure and stress tests


## Summary

Implemented two principle violations identified in the codebase survey:

1. **Instrumentation Principle** — Added structured logging throughout the codebase
2. **Stress Testing Requirement** — Created stress test suite with performance baselines


## Changes Made


### Part 1: Documentation Updates

1. **`docs/seed-design/prd_2026-01-19.md`**
   - Added Section 18: Development Standards
   - Subsections for logging, testing, and stress testing standards
   - These apply to both human code and Claude-generated code

2. **`docs/architecture-v1.md`**
   - Added "Logging & Observability" section
   - Documents logger categories, viewing logs, log levels, usage patterns

3. **`docs/seed-design/handoff-2026-01-21.md`**
   - Added "Debugging Workflow" section
   - Added "Honor System Note for Claude"

4. **`docs/stress-testing.md`** (new)
   - Complete stress test documentation
   - Performance baselines from initial run


### Part 2: Logging Infrastructure

1. **`Sources/TavernCore/Logging/TavernLogger.swift`** (new)
   - Four logger categories: `agents`, `chat`, `coordination`, `claude`
   - Subsystem: `com.tavern.spillway`

2. **Instrumented Files:**
   - `Jake.swift` — API calls, state transitions, errors
   - `MortalAgent.swift` — State transitions, completion detection, verification
   - `ChatViewModel.swift` — Message flow, errors
   - `TavernCoordinator.swift` — Agent selection, spawn, dismiss
   - `AgentSpawner.swift` — Spawn requests, name generation, registration


### Part 3: Stress Testing

1. **`Package.swift`**
   - Added `TavernStressTests` target

2. **Test Files Created:**
   - `ChatStressTests.swift` — Message volume, history access
   - `AgentSpawnerStressTests.swift` — Spawn volume, rapid cycles, theme exhaustion
   - `ConcurrencyStressTests.swift` — Concurrent messages, spawn/dismiss, thread safety

3. **Test Results (8 tests, all passing):**
   ```
   testManyMessagesInSingleChat: 1000 messages in 0.10s
   testLargeMessageHistory: 10K message setup + access in 5.4s
   testManyAgentsSpawned: 100 agents in 0.001s
   testRapidSpawnDismissCycle: 50 cycles in 0.001s
   testThemeExhaustion: 500 agents, 467 fallback names in 0.016s
   testConcurrentAgentMessages: 1000 messages from 10 agents in 0.01s
   testConcurrentSpawnDismiss: 5×20 operations in 0.003s
   testRegistryThreadSafety: 1000 iterations in 0.09s
   ```


## Principles Established

1. **All new code must be instrumented** — Use `TavernLogger` categories
2. **Debug builds should be diagnosable from logs alone** — No screenshots/videos needed
3. **Stress tests run before releases** — Not every build, but end of cycle
4. **Claude must follow same standards** — Honor system note in handoff doc


## Test Status

- 172 unit tests: passing
- 8 stress tests: passing
- Total: 180 tests passing


## Post-Implementation

After implementation completed:

1. **Build issue** — xcodebuild failed because `Logging/` directory wasn't in the Xcode project
   - Fixed by running `xcodegen generate` to regenerate the project
   - App builds and runs successfully

2. **README screenshot** — Added screenshot of the running app to `README.md`
   - Screenshot saved as `screenshot.png` in project root
   - Added image reference after intro section


## Additional Features

### Progressive Unlocks (PRD Section 8)

Added new PRD section for progressive content unlocking based on user engagement:

**Concept:**
- Track message count as user engages with the app
- Unlock content progressively: cogitating verbs, naming themes, Jake's vocabulary, easter eggs
- Feedback style: subtle hints only (Jake doesn't announce unlocks, just starts using new content)

**Open questions (intentionally deferred):**
- Scope: per-project vs global count vs both
- Thresholds: linear, milestone-based, or front-loaded
- Persistence: where to store the count
- Reset behavior: can users "prestige"?

All PRD sections renumbered (now 21 sections total).


### Xcode Project Settings

Updated `project.yml` to address "Update to Recommended Settings" warning:
- Changed `xcodeVersion` from "16.0" to "26.0" to match current Xcode
- Regenerated project with `xcodegen generate`
- Warning persists — likely specific build settings, not just version marker
- Next step: user will apply Xcode's recommendations via GUI
