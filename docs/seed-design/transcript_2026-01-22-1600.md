# Transcript: Redo Build System, Handoff Consolidation

**Date:** 2026-01-22 16:00
**Session:** Build workflow improvements and documentation consolidation


## Context

Continuing from previous session where SDK fix, session persistence, and agent spawn UI were implemented. This session focused on build workflow and consolidating documentation.


## Build Workflow Fix

**[U]** User pointed out I was building incorrectly — need to open `.app` file, not just run swift build output.

**[C]** Found that `project.yml` was still pointing to remote ClaudeCodeSDK instead of local fork. Fixed and regenerated with xcodegen.

**Fix applied:**
```yaml
# Before (broken):
packages:
  ClaudeCodeSDK:
    url: https://github.com/jamesrochabrun/ClaudeCodeSDK.git
    from: "1.0.0"

# After (working):
packages:
  ClaudeCodeSDK:
    path: LocalPackages/ClaudeCodeSDK
```

**[U]** User asked me to research the redo build tool and create .do files to manage the build process.


## Redo Build System

**[C]** Researched redo (apenwarr's implementation of djb's design):
- `.do` files are shell scripts that build targets
- `$1` = target name, `$2` = target without extension, `$3` = output file
- `redo-ifchange` declares dependencies and only rebuilds if changed
- `redo-always` forces rebuild every time (for tests, clean)

**Files created:**

| File | Purpose |
|------|---------|
| `all.do` | Default target, calls build |
| `build.do` | xcodebuild with correct derivedDataPath |
| `xcodegen.do` | Regenerate Xcode project from project.yml |
| `test.do` | Run all tests |
| `test-core.do` | Run TavernCoreTests only |
| `test-integration.do` | Run TavernTests only |
| `run.do` | Build + kill existing + launch app |
| `clean.do` | Remove build artifacts |
| `kill.do` | Kill running Tavern instances |

**[U]** "you can't pass env vars to redo"

**[C]** Fixed test.do — removed FILTER env var approach, created separate test-core.do and test-integration.do instead.


## Usage

```bash
cd Tavern
redo run              # Build + kill + launch
redo build            # Just build
redo test             # All tests
redo test-core        # TavernCoreTests only
redo clean            # Remove artifacts
```

Build output: `~/.local/builds/tavern` (avoids iCloud interference)


## Handoff Consolidation

**[U]** "turn the handoff doc into content for the claude.md in this project. let's see if we can make the handoff doc no longer needed"

**[C]** Analyzed handoff docs, identified:
- **Ephemeral content** (session IDs, recent commits, "what user was doing") — delete
- **Evergreen content** — find homes in CLAUDE.md

**[U]** "the minor details can go into either a design document, if it's about approach in depth, or into claude.md if it's just ensuring claude uses those key principles"

**Added to CLAUDE.md:**

1. **Project Structure** — Full directory tree at top
2. **Build Commands** — redo commands section
3. **Current State** — What works, what's not implemented
4. **Key Files** — Table of important files
5. **Debugging** — Console.app filters, category filters, diagnosing issues checklist
6. **Design Principles:**
   - Sum Type Error Design (enumerate failure modes upfront)
   - App Restart Workflow (use `redo run` after rebuilding)
7. **Seed Design Interview Process** — Expanded with:
   - Two Input Streams concept
   - Why This Exists rationale
   - Key Rule about transcribing new principles
8. **iCloud Issue** — Root cause details, permanent fix options

**Deleted:**
- `docs/seed-design/handoff-2026-01-21.md`
- `docs/seed-design/handoff-sessions-2026-01-21.md`


## Redo Refinements

**[U]** "we shouldn't be making those output turds in the first place, usually the convention is to push messages to stderr, when inside do files"

**[C]** Fixed all .do files — stdout goes to target file in redo, so all echo/output must go to stderr (`>&2`).

**[U]** "why's this all in Tavern, and not the root of the project?"

**[C]** Build-specific .do files stay in Tavern/ (where build context is). User okay with `redo Tavern/build` syntax.

**[U]** "but clean should be for the whole project"

**[C]** Moved `clean.do` to project root. Now cleans:
- Derived data (`~/.local/builds/tavern`)
- SPM build dirs (`Tavern/.build`, `LocalPackages/.build`)
- redo state (`.redo`, `Tavern/.redo`)
- Corrupted xcodeproj files (iCloud artifacts)

**[U]** "redo clean should clean out the running app. also maybe do that through a Tavern/stop target?"

**[C]** Renamed `Tavern/kill.do` → `Tavern/stop.do`. Updated `clean.do` to call `redo Tavern/stop` first.

**Final structure:**
```
the-tavern-at-the-spillway/
├── clean.do              # Project-wide clean (calls Tavern/stop)
└── Tavern/
    ├── build.do          # xcodebuild
    ├── run.do            # build + stop + launch
    ├── stop.do           # pkill Tavern.app
    ├── test.do           # all tests
    ├── test-core.do      # TavernCoreTests
    ├── test-integration.do
    ├── xcodegen.do
    └── all.do
```

**Usage from project root:**
```bash
redo clean                    # Stop app + clean everything
redo Tavern/build             # Build
redo Tavern/run               # Build + launch
redo Tavern/stop              # Stop running app
redo Tavern/test              # Run tests
```


## Files Changed This Session

| File | Change |
|------|--------|
| `Tavern/project.yml` | Point to local SDK |
| `Tavern/*.do` (8 files) | NEW — redo build scripts (all output to stderr) |
| `clean.do` | NEW at root — project-wide clean, calls Tavern/stop |
| `.gitignore` | Added `.redo/` |
| `CLAUDE.md` | Merged handoff content, added principles, updated redo docs |
| `docs/seed-design/handoff-*.md` | DELETED |


## Principles Reinforced

- **App Restart Workflow** — After rebuilding, stop and relaunch for testing
- **Single Source of Truth** — CLAUDE.md is now the authoritative project context file
- **redo convention** — All .do script output to stderr, stdout reserved for target content


---

*All 173 tests passing. App running from `~/.local/builds/tavern`.*
